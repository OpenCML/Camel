module phot_example

import { config, gen_bits, modulation, up_sample, pulse_shaper, constellation_diagram } from phot

func main(): int sync {
    // Step 0: Configure phot library
    "Step 0: Configuring phot library..." ->println
    config(true)

    // Parameters
    let num_symbols = 2^16
    let bits_per_symbol = 3
    let roll_off: double = 0.01
    let total_baud: double = 40.0e9
    let up_sampling_factor = 4
    let sampling_rate = double(up_sampling_factor) * total_baud
    let reference_frequency = 193.1e12

    // Step 1: Bit generation
    "Step 1: Generating random bits..." ->println
    let num_bits = num_symbols * bits_per_symbol
    "  total bits = {} ({} symbols x {} bits/symbol)"
        ->format<num_bits, num_symbols, bits_per_symbol>
        ->println

    let signal_bits = gen_bits(num_bits, bits_per_symbol)
    let (bits_x, bits_y) = signal_bits
    "  bit sequence X length: {} | Y length: {}"
        ->format<len(bits_x), len(bits_y)>
        ->println

    // Step 2: Modulation
    "Step 2: Modulating signals..." ->println
    let signals = modulation<bits_per_symbol>(signal_bits)
    let (x_pol, y_pol) = signals
    let (real_before, imag_before) = x_pol

    "  generated {} symbols"
        ->format<len(real_before)>
        ->println
    "  example X_pol (real, imag): {:.3f}, {:.3f}, {:.3f}, {:.3f}, {:.3f}"
        ->format<real_before[0], real_before[1], real_before[2], real_before[3], real_before[4]>
        ->println

    // Step 3: Upsampling
    "Step 3: Upsampling x{}..."
        ->format<up_sampling_factor>
        ->println
    let upsampled_signals = up_sample<up_sampling_factor>(signals)
    let (x_pol_upsampled, y_pol_upsampled) = upsampled_signals
    let (real_upsampled, imag_upsampled) = x_pol_upsampled
    "  upsampled length: {}"
        ->format<len(real_upsampled)>
        ->println
    "  first 5 real samples: {:.3f}, {:.3f}, {:.3f}, {:.3f}, {:.3f}"
        ->format<real_upsampled[0], real_upsampled[1], real_upsampled[2], real_upsampled[3], real_upsampled[4]>
        ->println

    // Step 4: Pulse shaping
    "Step 4: RRC pulse shaping (rolloff = {:.3f})..."
        ->format<roll_off>
        ->println
    let shaped_signals = pulse_shaper<up_sampling_factor, roll_off, total_baud>(upsampled_signals)
    let (x_pol_final, y_pol_final) = shaped_signals
    let (real_final, imag_final) = x_pol_final
    "  first 5 shaped real: {:.3f}, {:.3f}, {:.3f}, {:.3f}, {:.3f}"
        ->format<real_final[0], real_final[1], real_final[2], real_final[3], real_final[4]>
        ->println

    // Step 5: Constellation plot
    "Step 5: Plotting constellation diagram..." ->println
    constellation_diagram<true, false>(shaped_signals)

    return 0
}
