module fib

import { now } from time
import { sqrt } from math
import { mean, stdev } from statistics

func fib(n: int): int {
    return if n <= 1 then n else fib(n - 1) + fib(n - 2)
}

with <var result: float[], repeat: int>
export sync func timeit(fn: () => void): void {
    if repeat <= 0 then {
        return null
    } else sync {
        let start = now()
        fn()
        let duration = now() - start
        result->append<float(duration)>
        return timeit<result, repeat - 1>(fn)
    }
}

func main(): int sync {
    let repeat = 100
    var results: float[] = [0.0]->tail

    timeit<results, repeat>(() => sync {
        let idx = 30
        let res = fib(idx)
        'fib({}) = {}'->format<idx, res>->println
    })

    // 计算均值和标准差
    let average = float(mean(results)) * 1000.0
    let std_dev = float(stdev(results)) * 1000.0

    // 95% 置信区间（Z 值 1.96）
    let z_value = 1.96
    let margin_error = z_value * (std_dev / sqrt(repeat))

    'average time cost: {:.2f} +/- {:.2f} ms (95% CI)'
        ->format<average, margin_error>
        ->println

    return 0
}
